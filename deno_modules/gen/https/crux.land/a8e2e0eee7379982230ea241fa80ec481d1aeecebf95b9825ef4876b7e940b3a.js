export function defaultOtherHandler(_req) {
    return new Response(null, {
        status: 404,
    });
}
export function defaultErrorHandler(_req, _ctx, err) {
    console.error(err);
    return new Response(null, {
        status: 500,
    });
}
export function defaultUnknownMethodHandler(_req, _ctx, knownMethods) {
    return new Response(null, {
        status: 405,
        headers: {
            Accept: knownMethods.join(", "),
        },
    });
}
export const METHODS = [
    "GET",
    "HEAD",
    "POST",
    "PUT",
    "DELETE",
    "OPTIONS",
    "PATCH",
];
const methodRegex = new RegExp(`(?<=^(?:${METHODS.join("|")}))@`);
export function router(routes, other = defaultOtherHandler, error = defaultErrorHandler, unknownMethod = defaultUnknownMethodHandler) {
    const internalRoutes = {};
    for (const [route, handler] of Object.entries(routes)) {
        let [methodOrPath, path] = route.split(methodRegex);
        let method = methodOrPath;
        if (!path) {
            path = methodOrPath;
            method = "any";
        }
        const r = internalRoutes[path] ?? {
            pattern: new URLPattern({ pathname: path }),
            methods: {}
        };
        r.methods[method] = handler;
        internalRoutes[path] = r;
    }
    return async (req, ctx) => {
        try {
            for (const { pattern, methods } of Object.values(internalRoutes)) {
                const res = pattern.exec(req.url);
                if (res !== null) {
                    for (const [method, handler] of Object.entries(methods)) {
                        if (req.method === method) {
                            return await handler(req, ctx, res.pathname.groups);
                        }
                    }
                    if (methods["any"]) {
                        return await methods["any"](req, ctx, res.pathname.groups);
                    }
                    else {
                        return await unknownMethod(req, ctx, Object.keys(methods));
                    }
                }
            }
            return await other(req, ctx);
        }
        catch (err) {
            return error(req, ctx, err);
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidVlRRy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInVZUUcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBcURBLE1BQU0sVUFBVSxtQkFBbUIsQ0FBQyxJQUFhO0lBQy9DLE9BQU8sSUFBSSxRQUFRLENBQUMsSUFBSSxFQUFFO1FBQ3hCLE1BQU0sRUFBRSxHQUFHO0tBQ1osQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUtELE1BQU0sVUFBVSxtQkFBbUIsQ0FDakMsSUFBYSxFQUNiLElBQW9CLEVBQ3BCLEdBQVk7SUFFWixPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRW5CLE9BQU8sSUFBSSxRQUFRLENBQUMsSUFBSSxFQUFFO1FBQ3hCLE1BQU0sRUFBRSxHQUFHO0tBQ1osQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUtELE1BQU0sVUFBVSwyQkFBMkIsQ0FDekMsSUFBYSxFQUNiLElBQW9CLEVBQ3BCLFlBQXNCO0lBRXRCLE9BQU8sSUFBSSxRQUFRLENBQUMsSUFBSSxFQUFFO1FBQ3hCLE1BQU0sRUFBRSxHQUFHO1FBQ1gsT0FBTyxFQUFFO1lBQ1AsTUFBTSxFQUFFLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1NBQ2hDO0tBQ0YsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELE1BQU0sQ0FBQyxNQUFNLE9BQU8sR0FBRztJQUNyQixLQUFLO0lBQ0wsTUFBTTtJQUNOLE1BQU07SUFDTixLQUFLO0lBQ0wsUUFBUTtJQUNSLFNBQVM7SUFDVCxPQUFPO0NBQ0MsQ0FBQztBQUVYLE1BQU0sV0FBVyxHQUFHLElBQUksTUFBTSxDQUFDLFdBQVcsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7QUF5QmxFLE1BQU0sVUFBVSxNQUFNLENBQ3BCLE1BQWlCLEVBQ2pCLFFBQW9CLG1CQUFtQixFQUN2QyxRQUF5QixtQkFBbUIsRUFDNUMsZ0JBQXlDLDJCQUEyQjtJQUVwRSxNQUFNLGNBQWMsR0FBc0YsRUFBRSxDQUFDO0lBQzdHLEtBQUssTUFBTSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQ3JELElBQUksQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNwRCxJQUFJLE1BQU0sR0FBRyxZQUFZLENBQUM7UUFDMUIsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNULElBQUksR0FBRyxZQUFZLENBQUM7WUFDcEIsTUFBTSxHQUFHLEtBQUssQ0FBQztTQUNoQjtRQUNELE1BQU0sQ0FBQyxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSTtZQUNoQyxPQUFPLEVBQUUsSUFBSSxVQUFVLENBQUMsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUM7WUFDM0MsT0FBTyxFQUFFLEVBQUU7U0FDWixDQUFDO1FBQ0YsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxPQUFPLENBQUM7UUFDNUIsY0FBYyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUMxQjtJQUVELE9BQU8sS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtRQUN4QixJQUFJO1lBQ0YsS0FBSyxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLEVBQUU7Z0JBQ2hFLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNsQyxJQUFJLEdBQUcsS0FBSyxJQUFJLEVBQUU7b0JBQ2hCLEtBQUssTUFBTSxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFO3dCQUN2RCxJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssTUFBTSxFQUFFOzRCQUN6QixPQUFPLE1BQU0sT0FBTyxDQUNsQixHQUFHLEVBQ0gsR0FBRyxFQUNILEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUNwQixDQUFDO3lCQUNIO3FCQUNGO29CQUNELElBQUksT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFO3dCQUNsQixPQUFPLE1BQU0sT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUN6QixHQUFHLEVBQ0gsR0FBRyxFQUNILEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUNwQixDQUFDO3FCQUNIO3lCQUFNO3dCQUNMLE9BQU8sTUFBTSxhQUFhLENBQ3hCLEdBQUcsRUFDSCxHQUFHLEVBQ0gsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FDckIsQ0FBQztxQkFDSDtpQkFDRjthQUNGO1lBRUQsT0FBTyxNQUFNLEtBQUssQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7U0FDOUI7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNaLE9BQU8sS0FBSyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7U0FDN0I7SUFDSCxDQUFDLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjIgZGVub3NhdXJzLiBBbGwgcmlnaHRzIHJlc2VydmVkLiBNSVQgbGljZW5zZS5cblxuaW1wb3J0IHR5cGUgeyBDb25uSW5mbyB9IGZyb20gXCJodHRwczovL2Rlbm8ubGFuZC9zdGRAMC4xMjguMC9odHRwL3NlcnZlci50c1wiO1xuXG50eXBlIEhhbmRsZXJDb250ZXh0PFQgPSB1bmtub3duPiA9IFQgJiBDb25uSW5mbztcblxuZXhwb3J0IHR5cGUgSGFuZGxlcjxUID0gdW5rbm93bj4gPSAoXG4gIHJlcTogUmVxdWVzdCxcbiAgY3R4OiBIYW5kbGVyQ29udGV4dDxUPixcbikgPT4gUmVzcG9uc2UgfCBQcm9taXNlPFJlc3BvbnNlPjtcblxuLyoqXG4gKiBBIGhhbmRsZXIgdHlwZSBmb3IgYW55dGltZSB0aGUgYE1hdGNoSGFuZGxlcmAgb3IgYG90aGVyYCBwYXJhbWV0ZXIgaGFuZGxlclxuICogZmFpbHNcbiAqL1xuZXhwb3J0IHR5cGUgRXJyb3JIYW5kbGVyPFQgPSB1bmtub3duPiA9IChcbiAgcmVxOiBSZXF1ZXN0LFxuICBjdHg6IEhhbmRsZXJDb250ZXh0PFQ+LFxuICBlcnI6IHVua25vd24sXG4pID0+IFJlc3BvbnNlIHwgUHJvbWlzZTxSZXNwb25zZT47XG5cbi8qKlxuICogQSBoYW5kbGVyIHR5cGUgZm9yIGFueXRpbWUgYSBtZXRob2QgaXMgcmVjZWl2ZWQgdGhhdCBpcyBub3QgZGVmaW5lZFxuICovXG5leHBvcnQgdHlwZSBVbmtub3duTWV0aG9kSGFuZGxlcjxUID0gdW5rbm93bj4gPSAoXG4gIHJlcTogUmVxdWVzdCxcbiAgY3R4OiBIYW5kbGVyQ29udGV4dDxUPixcbiAga25vd25NZXRob2RzOiBzdHJpbmdbXSxcbikgPT4gUmVzcG9uc2UgfCBQcm9taXNlPFJlc3BvbnNlPjtcblxuLyoqXG4gKiBBIGhhbmRsZXIgdHlwZSBmb3IgYSByb3V0ZXIgcGF0aCBtYXRjaCB3aGljaCBnZXRzIHBhc3NlZCB0aGUgbWF0Y2hlZCB2YWx1ZXNcbiAqL1xuZXhwb3J0IHR5cGUgTWF0Y2hIYW5kbGVyPFQgPSB1bmtub3duPiA9IChcbiAgcmVxOiBSZXF1ZXN0LFxuICBjdHg6IEhhbmRsZXJDb250ZXh0PFQ+LFxuICBtYXRjaDogUmVjb3JkPHN0cmluZywgc3RyaW5nPixcbikgPT4gUmVzcG9uc2UgfCBQcm9taXNlPFJlc3BvbnNlPjtcblxuLyoqXG4gKiBBIHJlY29yZCBvZiByb3V0ZSBwYXRocyBhbmQgYE1hdGNoSGFuZGxlcmBzIHdoaWNoIGFyZSBjYWxsZWQgd2hlbiBhIG1hdGNoIGlzXG4gKiBmb3VuZCBhbG9uZyB3aXRoIGl0J3MgdmFsdWVzLlxuICpcbiAqIFRoZSByb3V0ZSBwYXRocyBmb2xsb3cgdGhlIHBhdGgtdG8tcmVnZXhwIGZvcm1hdCB3aXRoIHRoZSBhZGRpdGlvbiBvZiBiZWluZyBhYmxlXG4gKiB0byBwcmVmaXggYSByb3V0ZSB3aXRoIGEgbWV0aG9kIG5hbWUgYW5kIHRoZSBgQGAgc2lnbi4gRm9yIGV4YW1wbGUgYSByb3V0ZSBvbmx5XG4gKiBhY2NlcHRpbmcgYEdFVGAgcmVxdWVzdHMgd291bGQgbG9vayBsaWtlOiBgR0VUQC9gLlxuICovXG4vLyBkZW5vLWxpbnQtaWdub3JlIGJhbi10eXBlc1xuZXhwb3J0IHR5cGUgUm91dGVzPFQgPSB7fT4gPSBSZWNvcmQ8c3RyaW5nLCBNYXRjaEhhbmRsZXI8VD4+O1xuXG4vKipcbiAqIFRoZSBkZWZhdWx0IG90aGVyIGhhbmRsZXIgZm9yIHRoZSByb3V0ZXJcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGRlZmF1bHRPdGhlckhhbmRsZXIoX3JlcTogUmVxdWVzdCk6IFJlc3BvbnNlIHtcbiAgcmV0dXJuIG5ldyBSZXNwb25zZShudWxsLCB7XG4gICAgc3RhdHVzOiA0MDQsXG4gIH0pO1xufVxuXG4vKipcbiAqIFRoZSBkZWZhdWx0IGVycm9yIGhhbmRsZXIgZm9yIHRoZSByb3V0ZXJcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGRlZmF1bHRFcnJvckhhbmRsZXIoXG4gIF9yZXE6IFJlcXVlc3QsXG4gIF9jdHg6IEhhbmRsZXJDb250ZXh0LFxuICBlcnI6IHVua25vd24sXG4pOiBSZXNwb25zZSB7XG4gIGNvbnNvbGUuZXJyb3IoZXJyKTtcblxuICByZXR1cm4gbmV3IFJlc3BvbnNlKG51bGwsIHtcbiAgICBzdGF0dXM6IDUwMCxcbiAgfSk7XG59XG5cbi8qKlxuICogVGhlIGRlZmF1bHQgdW5rbm93biBtZXRob2QgaGFuZGxlciBmb3IgdGhlIHJvdXRlclxuICovXG5leHBvcnQgZnVuY3Rpb24gZGVmYXVsdFVua25vd25NZXRob2RIYW5kbGVyKFxuICBfcmVxOiBSZXF1ZXN0LFxuICBfY3R4OiBIYW5kbGVyQ29udGV4dCxcbiAga25vd25NZXRob2RzOiBzdHJpbmdbXSxcbik6IFJlc3BvbnNlIHtcbiAgcmV0dXJuIG5ldyBSZXNwb25zZShudWxsLCB7XG4gICAgc3RhdHVzOiA0MDUsXG4gICAgaGVhZGVyczoge1xuICAgICAgQWNjZXB0OiBrbm93bk1ldGhvZHMuam9pbihcIiwgXCIpLFxuICAgIH0sXG4gIH0pO1xufVxuXG5leHBvcnQgY29uc3QgTUVUSE9EUyA9IFtcbiAgXCJHRVRcIixcbiAgXCJIRUFEXCIsXG4gIFwiUE9TVFwiLFxuICBcIlBVVFwiLFxuICBcIkRFTEVURVwiLFxuICBcIk9QVElPTlNcIixcbiAgXCJQQVRDSFwiLFxuXSBhcyBjb25zdDtcblxuY29uc3QgbWV0aG9kUmVnZXggPSBuZXcgUmVnRXhwKGAoPzw9Xig/OiR7TUVUSE9EUy5qb2luKFwifFwiKX0pKUBgKTtcblxuLyoqXG4gKiBBIHNpbXBsZSBhbmQgdGlueSByb3V0ZXIgZm9yIGRlbm9cbiAqXG4gKiBgYGBcbiAqIGltcG9ydCB7IHNlcnZlIH0gZnJvbSBcImh0dHBzOi8vZGVuby5sYW5kL3N0ZC9odHRwL3NlcnZlci50c1wiO1xuICogaW1wb3J0IHsgcm91dGVyIH0gZnJvbSBcImh0dHBzOi8vY3J1eC5sYW5kL3JvdXRlckAwLjAuOVwiO1xuICpcbiAqIGF3YWl0IHNlcnZlKFxuICogICByb3V0ZXIoe1xuICogICAgIFwiL1wiOiAoX3JlcSkgPT4gbmV3IFJlc3BvbnNlKFwiSGVsbG8gd29ybGQhXCIsIHsgc3RhdHVzOiAyMDAgfSksXG4gKiAgIH0pLFxuICogKTtcbiAqIGBgYFxuICpcbiAqIEBwYXJhbSByb3V0ZXMgQSByZWNvcmQgb2YgYWxsIHJvdXRlcyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyBoYW5kbGVyIGZ1bmN0aW9uc1xuICogQHBhcmFtIG90aGVyIEFuIG9wdGlvbmFsIHBhcmFtZXRlciB3aGljaCBjb250YWlucyBhIGhhbmRsZXIgZm9yIGFueXRoaW5nIHRoYXRcbiAqIGRvZXNuJ3QgbWF0Y2ggdGhlIGByb3V0ZXNgIHBhcmFtZXRlclxuICogQHBhcmFtIGVycm9yIEFuIG9wdGlvbmFsIHBhcmFtZXRlciB3aGljaCBjb250YWlucyBhIGhhbmRsZXIgZm9yIGFueSB0aW1lIGl0XG4gKiBmYWlscyB0byBydW4gdGhlIGRlZmF1bHQgcmVxdWVzdCBoYW5kbGluZyBjb2RlXG4gKiBAcGFyYW0gdW5rbm93bk1ldGhvZCBBbiBvcHRpb25hbCBwYXJhbWV0ZXIgd2hpY2ggY29udGFpbnMgYSBoYW5kbGVyIGZvciBhbnkgdGltZSBhIG1ldGhvZFxuICogdGhhdCBpcyBub3QgZGVmaW5lZCBpcyB1c2VkXG4gKiBAcmV0dXJucyBBIGRlbm8gc3RkIGNvbXBhdGlibGUgcmVxdWVzdCBoYW5kbGVyXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByb3V0ZXI8VCA9IHVua25vd24+KFxuICByb3V0ZXM6IFJvdXRlczxUPixcbiAgb3RoZXI6IEhhbmRsZXI8VD4gPSBkZWZhdWx0T3RoZXJIYW5kbGVyLFxuICBlcnJvcjogRXJyb3JIYW5kbGVyPFQ+ID0gZGVmYXVsdEVycm9ySGFuZGxlcixcbiAgdW5rbm93bk1ldGhvZDogVW5rbm93bk1ldGhvZEhhbmRsZXI8VD4gPSBkZWZhdWx0VW5rbm93bk1ldGhvZEhhbmRsZXIsXG4pOiBIYW5kbGVyPFQ+IHtcbiAgY29uc3QgaW50ZXJuYWxSb3V0ZXM6IFJlY29yZDxzdHJpbmcsIHsgcGF0dGVybjogVVJMUGF0dGVybiwgbWV0aG9kczogUmVjb3JkPHN0cmluZywgTWF0Y2hIYW5kbGVyPFQ+PiB9PiA9IHt9O1xuICBmb3IgKGNvbnN0IFtyb3V0ZSwgaGFuZGxlcl0gb2YgT2JqZWN0LmVudHJpZXMocm91dGVzKSkge1xuICAgIGxldCBbbWV0aG9kT3JQYXRoLCBwYXRoXSA9IHJvdXRlLnNwbGl0KG1ldGhvZFJlZ2V4KTtcbiAgICBsZXQgbWV0aG9kID0gbWV0aG9kT3JQYXRoO1xuICAgIGlmICghcGF0aCkge1xuICAgICAgcGF0aCA9IG1ldGhvZE9yUGF0aDtcbiAgICAgIG1ldGhvZCA9IFwiYW55XCI7XG4gICAgfVxuICAgIGNvbnN0IHIgPSBpbnRlcm5hbFJvdXRlc1twYXRoXSA/PyB7XG4gICAgICBwYXR0ZXJuOiBuZXcgVVJMUGF0dGVybih7IHBhdGhuYW1lOiBwYXRoIH0pLFxuICAgICAgbWV0aG9kczoge31cbiAgICB9O1xuICAgIHIubWV0aG9kc1ttZXRob2RdID0gaGFuZGxlcjtcbiAgICBpbnRlcm5hbFJvdXRlc1twYXRoXSA9IHI7XG4gIH1cblxuICByZXR1cm4gYXN5bmMgKHJlcSwgY3R4KSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGZvciAoY29uc3QgeyBwYXR0ZXJuLCBtZXRob2RzIH0gb2YgT2JqZWN0LnZhbHVlcyhpbnRlcm5hbFJvdXRlcykpIHtcbiAgICAgICAgY29uc3QgcmVzID0gcGF0dGVybi5leGVjKHJlcS51cmwpO1xuICAgICAgICBpZiAocmVzICE9PSBudWxsKSB7XG4gICAgICAgICAgZm9yIChjb25zdCBbbWV0aG9kLCBoYW5kbGVyXSBvZiBPYmplY3QuZW50cmllcyhtZXRob2RzKSkge1xuICAgICAgICAgICAgaWYgKHJlcS5tZXRob2QgPT09IG1ldGhvZCkge1xuICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgaGFuZGxlcihcbiAgICAgICAgICAgICAgICByZXEsXG4gICAgICAgICAgICAgICAgY3R4LFxuICAgICAgICAgICAgICAgIHJlcy5wYXRobmFtZS5ncm91cHMsXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChtZXRob2RzW1wiYW55XCJdKSB7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgbWV0aG9kc1tcImFueVwiXShcbiAgICAgICAgICAgICAgcmVxLFxuICAgICAgICAgICAgICBjdHgsXG4gICAgICAgICAgICAgIHJlcy5wYXRobmFtZS5ncm91cHMsXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdW5rbm93bk1ldGhvZChcbiAgICAgICAgICAgICAgcmVxLFxuICAgICAgICAgICAgICBjdHgsXG4gICAgICAgICAgICAgIE9iamVjdC5rZXlzKG1ldGhvZHMpLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGF3YWl0IG90aGVyKHJlcSwgY3R4KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiBlcnJvcihyZXEsIGN0eCwgZXJyKTtcbiAgICB9XG4gIH07XG59XG4iXX0=