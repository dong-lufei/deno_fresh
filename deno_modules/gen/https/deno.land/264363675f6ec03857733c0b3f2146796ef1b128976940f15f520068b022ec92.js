import { dirname, extname, fromFileUrl, join, toFileUrl, walk, } from "./deps.ts";
import { error } from "./error.ts";
export async function collect(directory) {
    const routesDir = join(directory, "./routes");
    const islandsDir = join(directory, "./islands");
    const routes = [];
    try {
        const routesUrl = toFileUrl(routesDir);
        for await (const _ of Deno.readDir(routesDir)) {
        }
        const routesFolder = walk(routesDir, {
            includeDirs: false,
            includeFiles: true,
            exts: ["tsx", "jsx", "ts", "js"],
        });
        for await (const entry of routesFolder) {
            if (entry.isFile) {
                const file = toFileUrl(entry.path).href.substring(routesUrl.href.length);
                routes.push(file);
            }
        }
    }
    catch (err) {
        if (err instanceof Deno.errors.NotFound) {
        }
        else {
            throw err;
        }
    }
    routes.sort();
    const islands = [];
    try {
        const islandsUrl = toFileUrl(islandsDir);
        for await (const entry of Deno.readDir(islandsDir)) {
            if (entry.isDirectory) {
                error(`Found subdirectory '${entry.name}' in islands/. The islands/ folder must not contain any subdirectories.`);
            }
            if (entry.isFile) {
                const ext = extname(entry.name);
                if (![".tsx", ".jsx", ".ts", ".js"].includes(ext))
                    continue;
                const path = join(islandsDir, entry.name);
                const file = toFileUrl(path).href.substring(islandsUrl.href.length);
                islands.push(file);
            }
        }
    }
    catch (err) {
        if (err instanceof Deno.errors.NotFound) {
        }
        else {
            throw err;
        }
    }
    islands.sort();
    return { routes, islands };
}
export async function generate(directory, manifest) {
    const { routes, islands } = manifest;
    const output = `// DO NOT EDIT. This file is generated by fresh.
// This file SHOULD be checked into source version control.
// This file is automatically updated during development when running \`dev.ts\`.

${routes.map((file, i) => `import * as $${i} from "./routes${file}";`).join("\n")}
${islands.map((file, i) => `import * as $$${i} from "./islands${file}";`)
        .join("\n")}

const manifest = {
  routes: {
    ${routes.map((file, i) => `${JSON.stringify(`./routes${file}`)}: $${i},`)
        .join("\n    ")}
  },
  islands: {
    ${islands.map((file, i) => `${JSON.stringify(`./islands${file}`)}: $$${i},`)
        .join("\n    ")}
  },
  baseUrl: import.meta.url,
};

export default manifest;
`;
    const proc = Deno.run({
        cmd: [Deno.execPath(), "fmt", "-"],
        stdin: "piped",
        stdout: "piped",
        stderr: "null",
    });
    const raw = new ReadableStream({
        start(controller) {
            controller.enqueue(new TextEncoder().encode(output));
            controller.close();
        },
    });
    await raw.pipeTo(proc.stdin.writable);
    const out = await proc.output();
    await proc.status();
    proc.close();
    const manifestStr = new TextDecoder().decode(out);
    const manifestPath = join(directory, "./fresh.gen.ts");
    await Deno.writeTextFile(manifestPath, manifestStr);
    console.log(`%cThe manifest has been generated for ${routes.length} routes and ${islands.length} islands.`, "color: blue; font-weight: bold");
}
export async function dev(base, entrypoint) {
    entrypoint = new URL(entrypoint, base).href;
    const dir = dirname(fromFileUrl(base));
    let currentManifest;
    const prevManifest = Deno.env.get("FRSH_DEV_PREVIOUS_MANIFEST");
    if (prevManifest) {
        currentManifest = JSON.parse(prevManifest);
    }
    else {
        currentManifest = { islands: [], routes: [] };
    }
    const newManifest = await collect(dir);
    Deno.env.set("FRSH_DEV_PREVIOUS_MANIFEST", JSON.stringify(newManifest));
    const manifestChanged = !arraysEqual(newManifest.routes, currentManifest.routes) ||
        !arraysEqual(newManifest.islands, currentManifest.islands);
    if (manifestChanged)
        await generate(dir, newManifest);
    await import(entrypoint);
}
function arraysEqual(a, b) {
    if (a.length !== b.length)
        return false;
    for (let i = 0; i < a.length; ++i) {
        if (a[i] !== b[i])
            return false;
    }
    return true;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibW9kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxPQUFPLEVBQ1AsT0FBTyxFQUNQLFdBQVcsRUFDWCxJQUFJLEVBQ0osU0FBUyxFQUNULElBQUksR0FDTCxNQUFNLFdBQVcsQ0FBQztBQUNuQixPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBT25DLE1BQU0sQ0FBQyxLQUFLLFVBQVUsT0FBTyxDQUFDLFNBQWlCO0lBQzdDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDOUMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUVoRCxNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUM7SUFDbEIsSUFBSTtRQUNGLE1BQU0sU0FBUyxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUd2QyxJQUFJLEtBQUssRUFBRSxNQUFNLENBQUMsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFO1NBRTlDO1FBQ0QsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNuQyxXQUFXLEVBQUUsS0FBSztZQUNsQixZQUFZLEVBQUUsSUFBSTtZQUNsQixJQUFJLEVBQUUsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUM7U0FDakMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxLQUFLLEVBQUUsTUFBTSxLQUFLLElBQUksWUFBWSxFQUFFO1lBQ3RDLElBQUksS0FBSyxDQUFDLE1BQU0sRUFBRTtnQkFDaEIsTUFBTSxJQUFJLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUMvQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FDdEIsQ0FBQztnQkFDRixNQUFNLENB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QUMsQ0FBQyxDQUFDLENBQUM7WUFBRSxPQUFPLEtBQUssQ0FBQztLQUNqQztJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIGRpcm5hbWUsXG4gIGV4dG5hbWUsXG4gIGZyb21GaWxlVXJsLFxuICBqb2luLFxuICB0b0ZpbGVVcmwsXG4gIHdhbGssXG59IGZyb20gXCIuL2RlcHMudHNcIjtcbmltcG9ydCB7IGVycm9yIH0gZnJvbSBcIi4vZXJyb3IudHNcIjtcblxuaW50ZXJmYWNlIE1hbmlmZXN0IHtcbiAgcm91dGVzOiBzdHJpbmdbXTtcbiAgaXNsYW5kczogc3RyaW5nW107XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjb2xsZWN0KGRpcmVjdG9yeTogc3RyaW5nKTogUHJvbWlzZTxNYW5pZmVzdD4ge1xuICBjb25zdCByb3V0ZXNEaXIgPSBqb2luKGRpcmVjdG9yeSwgXCIuL3JvdXRlc1wiKTtcbiAgY29uc3QgaXNsYW5kc0RpciA9IGpvaW4oZGlyZWN0b3J5LCBcIi4vaXNsYW5kc1wiKTtcblxuICBjb25zdCByb3V0ZXMgPSBbXTtcbiAgdHJ5IHtcbiAgICBjb25zdCByb3V0ZXNVcmwgPSB0b0ZpbGVVcmwocm91dGVzRGlyKTtcbiAgICAvLyBUT0RPKGx1Y2FjYXNvbmF0byk6IHJlbW92ZSB0aGUgZXh0cmFuaW91cyBEZW5vLnJlYWREaXIgd2hlblxuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9kZW5vbGFuZC9kZW5vX3N0ZC9pc3N1ZXMvMTMxMCBpcyBmaXhlZC5cbiAgICBmb3IgYXdhaXQgKGNvbnN0IF8gb2YgRGVuby5yZWFkRGlyKHJvdXRlc0RpcikpIHtcbiAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICB9XG4gICAgY29uc3Qgcm91dGVzRm9sZGVyID0gd2Fsayhyb3V0ZXNEaXIsIHtcbiAgICAgIGluY2x1ZGVEaXJzOiBmYWxzZSxcbiAgICAgIGluY2x1ZGVGaWxlczogdHJ1ZSxcbiAgICAgIGV4dHM6IFtcInRzeFwiLCBcImpzeFwiLCBcInRzXCIsIFwianNcIl0sXG4gICAgfSk7XG4gICAgZm9yIGF3YWl0IChjb25zdCBlbnRyeSBvZiByb3V0ZXNGb2xkZXIpIHtcbiAgICAgIGlmIChlbnRyeS5pc0ZpbGUpIHtcbiAgICAgICAgY29uc3QgZmlsZSA9IHRvRmlsZVVybChlbnRyeS5wYXRoKS5ocmVmLnN1YnN0cmluZyhcbiAgICAgICAgICByb3V0ZXNVcmwuaHJlZi5sZW5ndGgsXG4gICAgICAgICk7XG4gICAgICAgIHJvdXRlcy5wdXNoKGZpbGUpO1xuICAgICAgfVxuICAgIH1cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKGVyciBpbnN0YW5jZW9mIERlbm8uZXJyb3JzLk5vdEZvdW5kKSB7XG4gICAgICAvLyBEbyBub3RoaW5nLlxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG4gIHJvdXRlcy5zb3J0KCk7XG5cbiAgY29uc3QgaXNsYW5kcyA9IFtdO1xuICB0cnkge1xuICAgIGNvbnN0IGlzbGFuZHNVcmwgPSB0b0ZpbGVVcmwoaXNsYW5kc0Rpcik7XG4gICAgZm9yIGF3YWl0IChjb25zdCBlbnRyeSBvZiBEZW5vLnJlYWREaXIoaXNsYW5kc0RpcikpIHtcbiAgICAgIGlmIChlbnRyeS5pc0RpcmVjdG9yeSkge1xuICAgICAgICBlcnJvcihcbiAgICAgICAgICBgRm91bmQgc3ViZGlyZWN0b3J5ICcke2VudHJ5Lm5hbWV9JyBpbiBpc2xhbmRzLy4gVGhlIGlzbGFuZHMvIGZvbGRlciBtdXN0IG5vdCBjb250YWluIGFueSBzdWJkaXJlY3Rvcmllcy5gLFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGVudHJ5LmlzRmlsZSkge1xuICAgICAgICBjb25zdCBleHQgPSBleHRuYW1lKGVudHJ5Lm5hbWUpO1xuICAgICAgICBpZiAoIVtcIi50c3hcIiwgXCIuanN4XCIsIFwiLnRzXCIsIFwiLmpzXCJdLmluY2x1ZGVzKGV4dCkpIGNvbnRpbnVlO1xuICAgICAgICBjb25zdCBwYXRoID0gam9pbihpc2xhbmRzRGlyLCBlbnRyeS5uYW1lKTtcbiAgICAgICAgY29uc3QgZmlsZSA9IHRvRmlsZVVybChwYXRoKS5ocmVmLnN1YnN0cmluZyhpc2xhbmRzVXJsLmhyZWYubGVuZ3RoKTtcbiAgICAgICAgaXNsYW5kcy5wdXNoKGZpbGUpO1xuICAgICAgfVxuICAgIH1cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKGVyciBpbnN0YW5jZW9mIERlbm8uZXJyb3JzLk5vdEZvdW5kKSB7XG4gICAgICAvLyBEbyBub3RoaW5nLlxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG4gIGlzbGFuZHMuc29ydCgpO1xuXG4gIHJldHVybiB7IHJvdXRlcywgaXNsYW5kcyB9O1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGUoZGlyZWN0b3J5OiBzdHJpbmcsIG1hbmlmZXN0OiBNYW5pZmVzdCkge1xuICBjb25zdCB7IHJvdXRlcywgaXNsYW5kcyB9ID0gbWFuaWZlc3Q7XG5cbiAgY29uc3Qgb3V0cHV0ID0gYC8vIERPIE5PVCBFRElULiBUaGlzIGZpbGUgaXMgZ2VuZXJhdGVkIGJ5IGZyZXNoLlxuLy8gVGhpcyBmaWxlIFNIT1VMRCBiZSBjaGVja2VkIGludG8gc291cmNlIHZlcnNpb24gY29udHJvbC5cbi8vIFRoaXMgZmlsZSBpcyBhdXRvbWF0aWNhbGx5IHVwZGF0ZWQgZHVyaW5nIGRldmVsb3BtZW50IHdoZW4gcnVubmluZyBcXGBkZXYudHNcXGAuXG5cbiR7XG4gICAgcm91dGVzLm1hcCgoZmlsZSwgaSkgPT4gYGltcG9ydCAqIGFzICQke2l9IGZyb20gXCIuL3JvdXRlcyR7ZmlsZX1cIjtgKS5qb2luKFxuICAgICAgXCJcXG5cIixcbiAgICApXG4gIH1cbiR7XG4gICAgaXNsYW5kcy5tYXAoKGZpbGUsIGkpID0+IGBpbXBvcnQgKiBhcyAkJCR7aX0gZnJvbSBcIi4vaXNsYW5kcyR7ZmlsZX1cIjtgKVxuICAgICAgLmpvaW4oXCJcXG5cIilcbiAgfVxuXG5jb25zdCBtYW5pZmVzdCA9IHtcbiAgcm91dGVzOiB7XG4gICAgJHtcbiAgICByb3V0ZXMubWFwKChmaWxlLCBpKSA9PiBgJHtKU09OLnN0cmluZ2lmeShgLi9yb3V0ZXMke2ZpbGV9YCl9OiAkJHtpfSxgKVxuICAgICAgLmpvaW4oXCJcXG4gICAgXCIpXG4gIH1cbiAgfSxcbiAgaXNsYW5kczoge1xuICAgICR7XG4gICAgaXNsYW5kcy5tYXAoKGZpbGUsIGkpID0+IGAke0pTT04uc3RyaW5naWZ5KGAuL2lzbGFuZHMke2ZpbGV9YCl9OiAkJCR7aX0sYClcbiAgICAgIC5qb2luKFwiXFxuICAgIFwiKVxuICB9XG4gIH0sXG4gIGJhc2VVcmw6IGltcG9ydC5tZXRhLnVybCxcbn07XG5cbmV4cG9ydCBkZWZhdWx0IG1hbmlmZXN0O1xuYDtcblxuICBjb25zdCBwcm9jID0gRGVuby5ydW4oe1xuICAgIGNtZDogW0Rlbm8uZXhlY1BhdGgoKSwgXCJmbXRcIiwgXCItXCJdLFxuICAgIHN0ZGluOiBcInBpcGVkXCIsXG4gICAgc3Rkb3V0OiBcInBpcGVkXCIsXG4gICAgc3RkZXJyOiBcIm51bGxcIixcbiAgfSk7XG4gIGNvbnN0IHJhdyA9IG5ldyBSZWFkYWJsZVN0cmVhbSh7XG4gICAgc3RhcnQoY29udHJvbGxlcikge1xuICAgICAgY29udHJvbGxlci5lbnF1ZXVlKG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShvdXRwdXQpKTtcbiAgICAgIGNvbnRyb2xsZXIuY2xvc2UoKTtcbiAgICB9LFxuICB9KTtcbiAgYXdhaXQgcmF3LnBpcGVUbyhwcm9jLnN0ZGluLndyaXRhYmxlKTtcbiAgY29uc3Qgb3V0ID0gYXdhaXQgcHJvYy5vdXRwdXQoKTtcbiAgYXdhaXQgcHJvYy5zdGF0dXMoKTtcbiAgcHJvYy5jbG9zZSgpO1xuXG4gIGNvbnN0IG1hbmlmZXN0U3RyID0gbmV3IFRleHREZWNvZGVyKCkuZGVjb2RlKG91dCk7XG4gIGNvbnN0IG1hbmlmZXN0UGF0aCA9IGpvaW4oZGlyZWN0b3J5LCBcIi4vZnJlc2guZ2VuLnRzXCIpO1xuXG4gIGF3YWl0IERlbm8ud3JpdGVUZXh0RmlsZShtYW5pZmVzdFBhdGgsIG1hbmlmZXN0U3RyKTtcbiAgY29uc29sZS5sb2coXG4gICAgYCVjVGhlIG1hbmlmZXN0IGhhcyBiZWVuIGdlbmVyYXRlZCBmb3IgJHtyb3V0ZXMubGVuZ3RofSByb3V0ZXMgYW5kICR7aXNsYW5kcy5sZW5ndGh9IGlzbGFuZHMuYCxcbiAgICBcImNvbG9yOiBibHVlOyBmb250LXdlaWdodDogYm9sZFwiLFxuICApO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGV2KGJhc2U6IHN0cmluZywgZW50cnlwb2ludDogc3RyaW5nKSB7XG4gIGVudHJ5cG9pbnQgPSBuZXcgVVJMKGVudHJ5cG9pbnQsIGJhc2UpLmhyZWY7XG5cbiAgY29uc3QgZGlyID0gZGlybmFtZShmcm9tRmlsZVVybChiYXNlKSk7XG5cbiAgbGV0IGN1cnJlbnRNYW5pZmVzdDogTWFuaWZlc3Q7XG4gIGNvbnN0IHByZXZNYW5pZmVzdCA9IERlbm8uZW52LmdldChcIkZSU0hfREVWX1BSRVZJT1VTX01BTklGRVNUXCIpO1xuICBpZiAocHJldk1hbmlmZXN0KSB7XG4gICAgY3VycmVudE1hbmlmZXN0ID0gSlNPTi5wYXJzZShwcmV2TWFuaWZlc3QpO1xuICB9IGVsc2Uge1xuICAgIGN1cnJlbnRNYW5pZmVzdCA9IHsgaXNsYW5kczogW10sIHJvdXRlczogW10gfTtcbiAgfVxuICBjb25zdCBuZXdNYW5pZmVzdCA9IGF3YWl0IGNvbGxlY3QoZGlyKTtcbiAgRGVuby5lbnYuc2V0KFwiRlJTSF9ERVZfUFJFVklPVVNfTUFOSUZFU1RcIiwgSlNPTi5zdHJpbmdpZnkobmV3TWFuaWZlc3QpKTtcblxuICBjb25zdCBtYW5pZmVzdENoYW5nZWQgPVxuICAgICFhcnJheXNFcXVhbChuZXdNYW5pZmVzdC5yb3V0ZXMsIGN1cnJlbnRNYW5pZmVzdC5yb3V0ZXMpIHx8XG4gICAgIWFycmF5c0VxdWFsKG5ld01hbmlmZXN0LmlzbGFuZHMsIGN1cnJlbnRNYW5pZmVzdC5pc2xhbmRzKTtcblxuICBpZiAobWFuaWZlc3RDaGFuZ2VkKSBhd2FpdCBnZW5lcmF0ZShkaXIsIG5ld01hbmlmZXN0KTtcblxuICBhd2FpdCBpbXBvcnQoZW50cnlwb2ludCk7XG59XG5cbmZ1bmN0aW9uIGFycmF5c0VxdWFsPFQ+KGE6IFRbXSwgYjogVFtdKTogYm9vbGVhbiB7XG4gIGlmIChhLmxlbmd0aCAhPT0gYi5sZW5ndGgpIHJldHVybiBmYWxzZTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhLmxlbmd0aDsgKytpKSB7XG4gICAgaWYgKGFbaV0gIT09IGJbaV0pIHJldHVybiBmYWxzZTtcbiAgfVxuICByZXR1cm4gdHJ1ZTtcbn1cbiJdfQ==